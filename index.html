<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LEGO Workshop</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="js/codemirror.js"></script>
    <script src="js/python.js"></script>
    <script src="js/mes_fonctions.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <img class="logo" src="img/lego_mindstorm_ev3.png" />
        <a class="navbar-brand" href="#"> :: LEGO Workshop ::</a>
        <img class="logo" src="img/lego_mindstorm_ev3.png" />
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <form class="form-inline my-2 my-lg-0">
                <input id="pseudo" class="form-control mr-sm-2" type="text" value="jbegood">
                <button id="executer" type="button" class="btn btn-success my-2 my-sm-0">Start</button>
                <button id="arreter" type="button" class="btn btn-danger my-2 my-sm-0">Stop</button>
                <a href="./help.html" target="_blank"><button id="aider" type="button" class="btn btn-info my-2 my-sm-0">Help</button></a>
            </form>
        </div>
    </nav>

    <main role="main" class="container">
        <h2>[Robot]</h2>
        <div class="row">
            <div class="col">
                <div id="network" class="alert alert-info" role="alert">Connection => <strong>...</strong></div>
            </div>
            <div class="col">
                <div id="execution" class="alert alert-info" role="alert">Execution => <strong>...</strong></div>
            </div>
        </div>

        <h2>[Éditor]</h2>
        <div id="zone_ide">
            <form>
                <textarea id="code_source">
# Librairies utilisées
import time

# Ici un commentaire
for i in range(0, 5):
    print("Hello world")
    time.sleep(1)
                </textarea>
            </form>

            <h2>[Output]</h2>
            <div id="sortie" class="alert alert-info" role="alert">...</div>
        </div><!-- zone_ide -->
    </main>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        /*
        // Création de la socket.io
        var socket = io.connect("http://" + document.domain + ":" + location.port);

        // Enregistrement des fonctions associées aux événements
        socket.on("connect", function() {
            socket.emit("message", {data: 'I\'m connected!'});
        });

        socket.on("execution_start", function() {
            //$("#executer").prop("disabled", true);
            //$("#arreter").prop("disabled", false);
        });

        socket.on("execution_stop", function() {
            //$("#executer").prop("disabled", false);
            //$("#arreter").prop("disabled", true);
        });
        */


        // Les variables
        var pseudo = document.getElementById("pseudo");
        var bouton_executer = document.getElementById("executer");
        var bouton_arreter = document.getElementById("arreter");
        var bouton_aider = document.getElementById("aider");
        var zone_sortie = document.getElementById("sortie");
        var zone_network = document.getElementById("network");
        var zone_execution = document.getElementById("execution");

        // Initialisation des boutons
        bouton_executer.disabled = true;
        bouton_arreter.disabled = true;

        // Configuration de l'éditeur en ligne Python
        var editeur = CodeMirror.fromTextArea(document.getElementById("code_source"), {
            mode: {name: "python",
                   version: 3,
                   singleLineStringErrors: false},
            lineNumbers: true,
            indentUnit: 4,
            matchBrackets: true
            //viewportMargin: 20
        });
        editeur.setSize(800, 500);

        // Gestion de la websocket
        var ip = location.host;
        var ws = new WebSocket("ws://" + ip + "/ws");

        ws.onopen = function(evt) {
            zone_network.innerHTML = "Connexion robot => <strong>OK (...)</strong>";
            zone_network.className="alert alert-success";
            console.log("OPEN");
            bouton_executer.disabled = false;
        }

        ws.onclose = function(evt) {
            zone_network.innerHTML = "Connexion robot => <strong>PERDUE (...)</strong>";
            zone_network.className="alert alert-danger";
            console.log("CLOSE");
            ws = null;
        }

        ws.onmessage = function(evt) {
            console.log("RESPONSE: " + evt.data);
            var trame = JSON.parse(evt.data);
            console.log("  source : " + trame.source);
            console.log("  action : " + trame.action);
            console.log("  details : " + trame.details);
            console.log("  exec_pid : " + trame.exec_pid);
            console.log("  exec_uid : " + trame.exec_uid);
            console.log("  clients : " + trame.clients);

            if (trame.action == "informer") {
                if (trame.details == "clients") {
                    zone_network.innerHTML = "Connexion robot => <strong>OK (" + trame.clients + ")</strong>";
                }

                if (trame.details == "executing") {
                    if (trame.exec_pid == 0) {
                        zone_execution.className="alert alert-info";
                        bouton_executer.disabled = false;
                        bouton_arreter.disabled = true;
                    } else {
                        zone_execution.className="alert alert-warning";
                        bouton_executer.disabled = true;
                        bouton_arreter.disabled = false;
                    }
                    zone_execution.innerHTML = "Exécution en cours => <strong>(PID=" + trame.exec_pid + ")</strong>";
                }
            }

            if (trame.action == "retourner") {
                if (trame.exec_pid == 0) {
                    zone_sortie.className="alert alert-success";
                    zone_sortie.innerHTML = "<strong>SUCCESS</strong><br /><pre>" + trame.details + "</pre>";
                } else if (trame.exec_pid == 100) {
                    zone_sortie.className="alert alert-danger";
                    zone_sortie.innerHTML = "<strong>ERROR</strong><br /><pre>" + trame.details + "</pre>";
                } else if (trame.exec_pid >= 566) {
                    zone_sortie.className="alert alert-danger";
                    zone_sortie.innerHTML = "<strong>KILLED</strong><br /><pre>" + trame.details + "</pre>";
                }

            }
            // Changement d'état du bouton
            //bouton_executer.disabled = false;
            //bouton_arreter.disabled = true;
        }

        ws.onerror = function(evt) {
            zone_network.innerHTML = "ERROR: " + evt.data;
            console.log("Connexion robot => ERROR (" + evt.data + ")");
        }


        // Gestion du bouton "Exécuter"
        $("#executer").click(function() {

            // Préparation de la trame
            console.log("Bouton [EXECUTER]");
            var trame = {
                source: pseudo.value,
                action: "lancer",
                details: editeur.getValue(),
                exec_pid: 0,
                exec_uid: "",
                clients: 0
            };

            // Envoi au travers de la websocket après JSONification
            ws.send( JSON.stringify(trame) );

            // Mise à jour de l'IHM
            zone_sortie.className="alert alert-info";
            zone_sortie.innerHTML = "<strong>WAITING</strong><br /><pre>...</pre>";
        });


        // Gestion du bouton "Arrêter"
        $("#arreter").click(function() {

            // Préparation de la trame
            console.log("Bouton [ARRETER]");
            var trame = {
                source: pseudo.value,
                action: "arreter",
                details: "",
                exec_pid: 0,
                exec_uid: "",
                clients: 0
            };

            // Envoi au travers de la websocket après JSONification
            ws.send( JSON.stringify(trame) );
        });


        // Gestion du bouton "Help"
        $("#aider").click(function() {
        });

    </script>

</body>

</html>
