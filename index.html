<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>LEGO Workshop</title>

    <!-- For Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- For CodeMirror -->
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="js/codemirror.js"></script>
    <script src="js/python.js"></script>

    <!-- For Fontawesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/solid.js" integrity="sha384-+Ga2s7YBbhOD6nie0DzrZpJes+b2K1xkpKxTFFcx59QmVPaSA8c7pycsNaFwUK6l" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/fontawesome.js" integrity="sha384-7ox8Q2yzO/uWircfojVuCQOZl+ZZBg2D2J5nkpLqzH1HY0C1dHlTKIbpRz/LG23c" crossorigin="anonymous"></script>

</head>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <img class="logo" src="img/logo_lycee.png" />
        <a class="navbar-brand" href="#">:: LEGO Workshop ::</a>
        <img class="logo" src="img/lego_mindstorm_ev3.png" />
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <form class="form-inline my-2 my-lg-0">
                <input id="pseudo" class="form-control mr-sm-2" type="text" value="your_name" min="5" max="15">
                <button id="executer" type="button" class="btn btn-success my-2 my-sm-0">
                    <i class="fas fa-play"></i>
                </button>
                <button id="arreter" type="button" class="btn btn-warning my-2 my-sm-0">
                    <i class="fas fa-stop"></i>
                </button>
                <button id="paniquer" type="button" class="btn btn-danger my-2 my-sm-0">
                    <i class="fas fa-times"></i>
                </button>
                <button id="aider" type="button" class="btn btn-info my-2 my-sm-0" data-toggle="modal" data-target="#aboutModal">
                    <i class="fas fa-info-circle"></i>
                </button>
                <!-- <i class="fas fa-upload"></i> -->
            </form>
        </div>
    </nav>

    <main role="main" class="container">

        <div class="row">

            <!-- EDITOR column -->
            <div class="col">
                <h2>[Editor]</h2>
                <div id="zone_ide">
                    <form>
                        <textarea id="code_source">
# Librairies utilisées
import time

# Ici un commentaire
for i in range(0, 5):
    print("Hello world")
    time.sleep(1)
                        </textarea>
                    </form>
                </div><!-- zone_ide -->
            </div><!-- Editor column end -->

            <!-- STATE column -->
            <div class="col">
                <h2>[State]</h2>
                <div id="network" class="alert alert-info" role="alert">
                    <i class="fas fa-wifi"></i> <i class="fas fa-long-arrow-alt-right"></i> <strong>...</strong>
                </div>
                <div id="execution" class="alert alert-info" role="alert">
                    <i class="fas fa-cog"></i> <i class="fas fa-long-arrow-alt-right"></i> <strong>...</strong>
                </div>

                <h2>[Program output]</h2>
                <div id="sortie" class="alert alert-info" role="alert">...</div>
            </div><!-- State column end -->
        </div>
    </main>

    <!-- Modal for [About] button -->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">:: LEGO Workshop v1.2 ::</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3>[Usage]</h3>
                    <p><button id="executer" type="button" class="btn-custom btn btn-success">
                        <i class="fas fa-play"></i>
                    </button> Upload and execute a Python script on the robot.</p>
                    <p><button id="arreter" type="button" class="btn-custom btn btn-warning">
                        <i class="fas fa-stop"></i>
                    </button> Stop a Python script on the robot.</p>
                    <p><button id="paniquer" type="button" class="btn-custom btn btn-danger">
                        <i class="fas fa-times"></i>
                    </button> Stop and reset the robot.</p>
                    <p><button id="aider" type="button" class="btn-custom btn btn-info">
                        <i class="fas fa-info-circle"></i>
                    </button> Print this page.</p>
                    <p><button id="aider" type="button" class="btn-custom btn btn-secondary">
                        <i class="fas fa-wifi"></i>
                    </button> Network state and number of co-worker(s) connected.</p>
                    <p><button id="aider" type="button" class="btn-custom btn btn-secondary">
                        <i class="fas fa-cog"></i>
                    </button> Python script execution ID and its owner.</p>
                    <br />
                    <h3>[Credits]</h3>
                    <p>Made with ❤ by David SALLÉ for the <a href="http://www.lycee-saintandre-niort.com">Saint-André high school</a> (ICN and ISN computer science classes)</p>
                    <p>More information here :<br /> <a href="https://github.com/freezed-or-frozen/lego-workshop">https://github.com/freezed-or-frozen/lego-workshop</a></p>
                </div>                
            </div>
        </div>
    </div>

    <!-- Javascript section -->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>-->
    <!--<script src="js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">-->
    <!--<script src="js/jquery-slim.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">

        // Les variables
        var pseudo = document.getElementById("pseudo");

        var bouton_executer = document.getElementById("executer");
        var bouton_arreter = document.getElementById("arreter");
        var bouton_aider = document.getElementById("aider");
        var bouton_paniquer = document.getElementById("paniquer");

        var zone_sortie = document.getElementById("sortie");
        var zone_network = document.getElementById("network");
        var zone_execution = document.getElementById("execution");

        // Initialisation des boutons
        bouton_executer.disabled = true;
        bouton_arreter.disabled = true;

        // Configuration de l'éditeur en ligne Python
        var editeur = CodeMirror.fromTextArea(document.getElementById("code_source"), {
            mode: {name: "python",
                   version: 3,
                   singleLineStringErrors: false},
            lineNumbers: true,
            indentUnit: 4,
            matchBrackets: true
            //viewportMargin: 20
        });
        editeur.setSize(600, 600);

        // Gestion de la websocket
        var ip = location.host;
        var ws = new WebSocket("ws://" + ip + "/ws");

        ws.onopen = function(evt) {
            zone_network.innerHTML = "<i class=\"fas fa-wifi\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>OK (...)</strong>";
            zone_network.className="alert alert-success";
            console.log("OPEN");
            bouton_executer.disabled = false;
        }

        ws.onclose = function(evt) {
            zone_network.innerHTML = "<i class=\"fas fa-wifi\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>LOST (...)</strong>";
            zone_network.className="alert alert-danger";
            console.log("CLOSE");
            ws = null;
        }

        ws.onmessage = function(evt) {
            console.log("RESPONSE: " + evt.data);
            var trame = JSON.parse(evt.data);
            console.log("  source : " + trame.source);
            console.log("  action : " + trame.action);
            console.log("  details : " + trame.details);
            console.log("  exec_pid : " + trame.exec_pid);
            console.log("  exec_uid : " + trame.exec_uid);
            console.log("  clients : " + trame.clients);

            if (trame.action == "informer") {
                if (trame.details == "clients") {
                    zone_network.innerHTML = "<i class=\"fas fa-wifi\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>OK (" + trame.clients + ")</strong>";
                    if (trame.exec_pid == 0) {
                        zone_execution.className="alert alert-info";
                        bouton_executer.disabled = false;
                        bouton_arreter.disabled = true;
                        zone_execution.innerHTML = "<i class=\"fas fa-cog\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>none</strong>";
                    } else {
                        zone_execution.className="alert alert-warning";
                        bouton_executer.disabled = true;
                        bouton_arreter.disabled = false;
                        zone_execution.innerHTML = "<i class=\"fas fa-cog fa-spin\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>PID_" + trame.exec_pid + "</strong> by <strong>" + trame.source + "</strong>";
                    }
                }

                if (trame.details == "executing") {
                    if (trame.exec_pid == 0) {
                        zone_execution.className="alert alert-info";
                        bouton_executer.disabled = false;
                        bouton_arreter.disabled = true;
                        zone_execution.innerHTML = "<i class=\"fas fa-cog\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>none</strong>";
                    } else {
                        zone_execution.className="alert alert-warning";
                        bouton_executer.disabled = true;
                        bouton_arreter.disabled = false;
                        zone_execution.innerHTML = "<i class=\"fas fa-cog fa-spin\"></i> <i class=\"fas fa-long-arrow-alt-right\"></i> <strong>PID_" + trame.exec_pid + "</strong> by <strong>" + trame.source + "</strong>";
                    }
                }
            }

            if (trame.action == "retourner") {
                if (trame.exec_pid == 0) {
                    zone_sortie.className="alert alert-success";
                    zone_sortie.innerHTML = "<strong>SUCCESS</strong> by <strong>" + trame.source + "</strong><br /><pre>" + trame.details + "</pre>";
                } else if (trame.exec_pid == 100) {
                    zone_sortie.className="alert alert-danger";
                    zone_sortie.innerHTML = "<strong>ERROR</strong> by <strong>" + trame.source + "</strong><br /><pre>" + trame.details + "</pre>";
                } else if (trame.exec_pid >= 566) {
                    zone_sortie.className="alert alert-danger";
                    zone_sortie.innerHTML = "<strong>KILLED</strong> by <strong>" + trame.source + "</strong><br /><pre>" + trame.details + "</pre>";
                }
            }
            // Changement d'état du bouton
            //bouton_executer.disabled = false;
            //bouton_arreter.disabled = true;
        }

        ws.onerror = function(evt) {
            zone_network.innerHTML = "ERROR: " + evt.data;
            console.log("Connection => ERROR (" + evt.data + ")");
        }


        // Fonction pour lire et limiter la taille du pseudo
        function readName()
        {
            var name = pseudo.value;
            if(name.length > 12) {
                name = name.substr(0, 12);
            }
            return name;
        }

        // Gestion du bouton "Exécuter"
        $("#executer").click(function() {

            // Préparation de la trame
            console.log("Bouton [EXECUTER]");
            var trame = {
                source: readName(),
                action: "lancer",
                details: editeur.getValue(),
                exec_pid: 0,
                exec_uid: "",
                clients: 0
            };

            // Envoi au travers de la websocket après JSONification
            ws.send( JSON.stringify(trame) );

            // Mise à jour de l'IHM
            zone_sortie.className="alert alert-info";
            zone_sortie.innerHTML = "<strong>WAITING</strong><br /><pre>...</pre>";
        });


        // Gestion du bouton "Arrêter"
        $("#arreter").click(function() {

            // Préparation de la trame
            console.log("Bouton [ARRETER]");
            var trame = {
                source: readName(),
                action: "arreter",
                details: "",
                exec_pid: 0,
                exec_uid: "",
                clients: 0
            };

            // Envoi au travers de la websocket après JSONification
            ws.send( JSON.stringify(trame) );
        });


        // Gestion du bouton "Help"
        $("#paniquer").click(function() {
            // Préparation de la trame
            console.log("Bouton [PANIQUER]");
            var trame = {
                source: readName(),
                action: "paniquer",
                details: "",
                exec_pid: 0,
                exec_uid: "",
                clients: 0
            };

            // Envoi au travers de la websocket après JSONification
            ws.send( JSON.stringify(trame) );
        });


        // Gestion du bouton "Help"
        $("#aider").click(function() {
        });

    </script>

</body>

</html>
